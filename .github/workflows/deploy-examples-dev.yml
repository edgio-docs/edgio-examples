name: Deploy Examples (dev-only)

on:
  pull_request:
  workflow_dispatch:

# In case you push new commit into the MR / the previous runs will automatically stop
concurrency:
  group: dev-examples-${{ github.ref }}
  cancel-in-progress: true

env:
  # Node version for all the jobs
  NODE_VERSION: 16

  # Set env var based on branch name
  GIT_REF: ${{ github.ref }}
  EDGIO_ENV: ${{ github.ref == 'refs/heads/main' && 'live' || 'test' }}
  EDGIO_TEAM: 'layer0-docs'
  EDGIO_SITE: 'edgio-examples'
  EDGIO_DEPLOY_TOKEN: ${{secrets.EDGIO_EXAMPLES_DEPLOY_TOKEN}}
  OPTIONAL_API_URL: --api-url=https://app.layer0.co

jobs:
  prepare-env:
    name: 'Prepare env for examples'
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.setMatrix.outputs.matrix }}
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-node@v3
        with:
          node-version: ${{ env.NODE_VERSION }} # NODE_VERSION
          registry-url: https://registry.npmjs.org/
      - name: 'Cache node modules'
        uses: actions/cache@v3
        env:
          cache-name: cache-packages-node-modules-node16-v1
        with:
          path: |
            node_modules
            */*/node_modules
          key: ${{ runner.os }}-build-${{ env.cache-name }}-${{ hashFiles('package-lock.json', 'packages/**/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-build-${{ env.cache-name }}-

      - name: 'Generate preid of this build'
        id: setPreid
        run: echo -e "preid=next-$(date +'%s')-$(git rev-parse --short HEAD)" >> $GITHUB_OUTPUT

      - run: npm ci

      - name: 'Load list of examples'
        id: setMatrix
        run: |
          echo -e "matrix=$(node scripts/helpers/printExamples.js)" >> $GITHUB_OUTPUT

  examples:
    name: 'Examples'
    needs: prepare-env
    runs-on: ubuntu-latest
    continue-on-error: true
    strategy:
      matrix:
        example: ${{ fromJson( needs.prepare-env.outputs.matrix ) }}
    env:
      EXAMPLE_DIR: examples/${{ matrix.example }}
      ENV_CMD_ARGS: --site=$EDGIO_SITE --team=$EDGIO_TEAM --token=$EDGIO_DEPLOY_TOKEN $OPTIONAL_API_URL
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-node@v3
        with:
          node-version: ${{ env.NODE_VERSION }} # NODE_VERSION
          registry-url: https://registry.npmjs.org/

      - name: 'Cache node modules'
        uses: actions/cache@v3
        env:
          cache-name: cache-examples-node-modules-${{ matrix.example }}-node16-v2
        with:
          path: |
            examples/${{ matrix.example }}/node_modules
            */*/node_modules
          key: ${{ runner.os }}-build-${{ env.cache-name }}-${{ hashFiles(format('examples/{0}/package-lock.json', matrix.test), 'packages/*/package-lock.json') }}

      # TODO: If the PR doesn't contain any changes in the example relative to the base branch, skip the matrix
      # - name: 'Check if there are changes in the example'
      #   id: checkChanges
      #   run: |
      #     echo -e "hasChanges=$(git status --porcelain --untracked-files=no ${{ env.EXAMPLE_DIR }} | wc -l)" >> $GITHUB_OUTPUT
      #     if [ $hasChanges = 0 ]; then
      #       echo "No changes in the example, exiting matrix."
      #       exit 0
      #     fi

      # Install dependencies for this example
      - name: 'Install dependencies'
        run: |
          npm i -g @edgio/cli

          # Check if package-lock.json file exists
          if [ -f "package-lock.json" ]; then
            # Use npm
            npm ci
          else
            # Check if yarn.lock file exists
            if [ -f "yarn.lock" ]; then
              # Use yarn
              yarn install --immutable
            else
              # No lock file found
              echo "No lock file found. Please run 'npm ci' or 'yarn install --frozen-lockfile' to install dependencies."
            fi
          fi
        working-directory: ${{ env.EXAMPLE_DIR }}

      - name: 'Disable analytics'
        run: edgio config set-analytics false

      - name: 'Prepare environments for the example'
        run: |
          output=$(eval "edgio env list $ENV_CMD_ARGS")

          # Get the lines that contain the list of environments
          envs=$(echo "$output" | grep -A 1000 "Environments:")

          # Remove the "Environments: " prefix from the first line and remove all lines before the first one
          envs=$(echo "$envs" | tail -n +2)

          # Replace all newline characters with a space
          envs=$(echo "$envs" | tr '\n' ' ')

          if [[ " $envs " =~ " $ENV_NAME " ]]; then
            # environment exists in the list; skip it
            echo "Environment '${ENV_NAME}' already exists in the list of environments and is being skipped."
          else
            # environment doesn't exist in the list; add it
            edgio env add $ENV_CMD_ARGS --environment=$ENV_NAME
          fi
        env:
          ENV_NAME: ${{ matrix.example }}-${{ env.EDGIO_ENV }}

      - name: 'Validate package scripts'
        run: node scripts/helpers/validatePackageScripts.js ${{ env.EXAMPLE_DIR }}

      - name: 'Deploy example'
        run: npm run edgio:deploy -- ${{ env.ENV_CMD_ARGS }} --environment=${{ env.ENV_NAME }}
        env:
          ENV_NAME: ${{ matrix.example }}-${{ env.EDGIO_ENV }}
        working-directory: ${{ env.EXAMPLE_DIR }}
